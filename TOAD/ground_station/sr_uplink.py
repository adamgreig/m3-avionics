#!/usr/bin/env python3

import sys
import struct
import serial

# Useage
if len(sys.argv) != 2:
    print("Usage: {} /dev/ttyACMx".format(sys.argv[0]))
    sys.exit(1)

# Message Type Definitions
MESSAGE_RX_PACKET   = 51   

# TOAD ID Definitions
TOAD_1 = 1
TOAD_2 = 2
TOAD_3 = 4
TOAD_4 = 8
TOAD_5 = 16
TOAD_6 = 32

# Packet Types
RANGE_PACKET = 64
POSITION_PACKET = 128

# Get TOAD ID from range/position packet
def get_toad_id_from_type(packet_type):

    if((packet_type & TOAD_1) == TOAD_1):
        print("Generated by TOAD 1")    
    
    if((packet_type & TOAD_2) == TOAD_2):
        print("Generated by TOAD 2") 
        
    if((packet_type & TOAD_3) == TOAD_3):
        print("Generated by TOAD 3") 
        
    if((packet_type & TOAD_4) == TOAD_4):
        print("Generated by TOAD 4") 
        
    if((packet_type & TOAD_5) == TOAD_5):
        print("Generated by TOAD 5") 
    
    if((packet_type & TOAD_6) == TOAD_6):
        print("Generated by TOAD 6")
        
        
# Open Serial Port
ser = serial.Serial(sys.argv[1])
print("Listening on", ser.name)

# Fetch & Decode
while True:

    # Read in a Log
    data = ser.read(128)
      
    # Get Message Metadata
    meta_data = struct.unpack('<BBI', data[0:6])
    log_type = meta_data[0]
    toad_id = meta_data[1]
    systick = meta_data[2]
    systick /= 10000.0
    
    # Handle SR Traffic - RX Packet Logged
    if (log_type == MESSAGE_RX_PACKET):
        print("SR TRAFFIC [RX Packet]:")
        print("TOAD ID = ", toad_id)
        print("Timestamp = ", systick, " s")            
        rx_type = data[6]
        get_toad_id_from_type(rx_type)
        
        # Handle Packet Types
        if ((rx_type & RANGE_PACKET) == RANGE_PACKET):
            payload = data[7:17]
            sr_rx_rp = struct.unpack('<IIBB', payload)
            print("time of flight = ", sr_rx_rp[0])
            print("i_tow = ", sr_rx_rp[1])
            print ("battery voltage = ", (sr_rx_rp[2]/10), "V")
            print("stm32 temp = ", sr_rx_rp[3], "degrees C")
            print('\n\n')
        
        if ((rx_type & POSITION_PACKET) == POSITION_PACKET):
            payload = data[7:22]
            sr_rx_pos = struct.unpack('<iiiBBB', payload)
            print("lon = ", (sr_rx_pos[0]/10000000), "degrees")
            print("lat = ", (sr_rx_pos[1]/10000000), "degrees")
            print("height = ", (sr_rx_pos[2]/1000), "m")  
            print("num sat = ", sr_rx_pos[3])
            print("battery voltage = ", (sr_rx_pos[4]/10), "V")
            print("stm32 temp = ", sr_rx_pos[5], "degrees C")
            print('\n\n')
